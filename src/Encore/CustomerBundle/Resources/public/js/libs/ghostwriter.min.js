// ghostwriter 0.2.0
// =================
// * GitHub: https://github.com/jharding/ghostwriter
// * Copyright (c) 2013 Jake Harding
// * Licensed under the MIT license.

(function(t,e){e.ghostwriter=t;var r=function(){var t=Array.prototype.concat;return{isString:function(t){return"string"==typeof t},isNumber:function(t){return"number"==typeof t},isFunction:$.isFunction,isArray:$.isArray,each:$.each,map:$.map,bind:$.proxy,merge:function(e){return t.apply([],e)},mixin:$.extend,getKeyEvent:function(t,e){var n=$.Event(t);if(n.ghostwriter=!0,"keypress"===t)n.which=n.keyCode=n.charCode=r.isString(e)?e.charCodeAt(0):e;else if("keydown"===t||"keyup"===t)n.charCode=0,n.which=n.charCode=r.isString(e)?e.toUpperCase().charCodeAt(0):e;else if("textInput"===t){if(!r.isString(e))throw new TypeError("non-string passed for textInput");n.data=e}return n},getSelection:function(t){var e,n,i,s,o,a=t[0],u=a.selectionStart,c=a.selectionEnd;if(r.isNumber(u))s=u,o=c;else if(a.createTextRange&&t.is(":focus")){for(s=o=0,e=a.value.length,n=document.selection.createRange(),i=a.createTextRange(),i.moveToBookmark(n.getBookmark());i.compareEndPoints("EndToStart",i);)i.moveEnd("character",-1),o++;for(i.setEndPoint("StartToStart",a.createTextRange());i.compareEndPoints("EndToStart",i);)i.moveEnd("character",-1),s++,o++}return{start:s,end:o}},setSelection:function(t,e,r){var n,i=t[0];i.setSelectionRange?i.setSelectionRange(e,r):i.createTextRange&&(n=i.createTextRange(),n.collapse(!0),n.moveEnd("character",e),n.moveStart("character",r),n.select())},getCursorPos:function(t){return r.getSelection(t).start},setCursorPos:function(t,e){r.setSelection(t,e,e)}}}(),n=function(){function t(){var t={};return r.each(n.definitions,function(r,n){t[r]=e(n,r)}),t}function e(t,e){var n=function(t){return this instanceof n?(this.args=t,this.name=e,void 0):new n([].slice.call(arguments,0))};return n.repeat=function(t){for(var e=[],r=new n;t--;)e.push(r);return e},r.mixin(n.prototype,{repeat:function(t){for(var e=[];t--;)e.push(this);return e},exec:function(e,r){t.apply(e,[r].concat(this.args))}}),n}return{builder:t,factory:e}}();n.definitions={character:function(t,e){var n,i,s=t.selection.start,o=t.selection.end;s===o?(n=t.val.beforeCursor+e+t.val.afterCursor,i=t.cursorPos+1):(n=t.val.all.slice(0,s)+e+t.val.all.slice(o),i=s+1),this.trigger(r.getKeyEvent("keydown",e)).trigger(r.getKeyEvent("keypress",e)).trigger(r.getKeyEvent("textInput",e)).val(n),r.setCursorPos(this,i),this.trigger(r.getKeyEvent("keyup",e)).trigger(r.getKeyEvent("input",e))},backspace:function(t){var e,n,i=8,s=t.selection.start,o=t.selection.end;s===o?(e=t.val.beforeCursor.slice(0,-1)+t.val.afterCursor,n=0===t.cursorPos?0:t.cursorPos-1):(e=t.val.all.slice(0,s)+t.val.all.slice(o),n=s),this.trigger(r.getKeyEvent("keydown",i)).val(e),r.setCursorPos(this,n),this.trigger(r.getKeyEvent("keyup",i)),this.val()!==t.val.all&&this.trigger(r.getKeyEvent("input",i))},right:function(t){var e=39,n=t.selection.start,i=t.selection.end,s=n===i?t.cursorPos+1:i;this.trigger(r.getKeyEvent("keydown",e)),r.setCursorPos(this,s),this.trigger(r.getKeyEvent("keyup",e))},left:function(t){var e=37,n=t.selection.start,i=t.selection.end,s=n===i?t.cursorPos-1:n;this.trigger(r.getKeyEvent("keydown",e)),r.setCursorPos(this,s),this.trigger(r.getKeyEvent("keyup",e))},up:function(){var t=38;this.trigger(r.getKeyEvent("keydown",t)).trigger(r.getKeyEvent("keyup",t))},down:function(){var t=40;this.trigger(r.getKeyEvent("keydown",t)).trigger(r.getKeyEvent("keyup",t))},enter:function(){var t=13;this.trigger(r.getKeyEvent("keydown",t)).trigger(r.getKeyEvent("keyup",t))},tab:function(){var t=9;this.trigger(r.getKeyEvent("keydown",t)).trigger(r.getKeyEvent("keyup",t))},esc:function(){var t=27;this.trigger(r.getKeyEvent("keydown",t)).trigger(r.getKeyEvent("keyup",t))},selectLeft:function(t){r.setSelection(this,t.selection.start-1,t.selection.end)},selectRight:function(t){r.setSelection(this,t.selection.start,t.selection.end+1)},selectAll:function(){this.select()},trigger:function(t,e){this.trigger(e)},noop:function(){}};var i=function(){function e(t){this.loop=!!t.loop,this.intervalId=null,this.interval=t.interval||300,this.$input=$(t.input).first(),this.originalInputVal=this.$input.val(),this.story=[],this.manuscript=n(t.manuscript)}function n(e){return e=r.isString(e)?[e]:e,e=r.map(e,function(e){return r.isString(e)?r.map(e.split(""),function(e){return t.character(e)}):e}),r.merge(e)}function i(){var t=this.story.shift(),e=this.$input.val(),n=r.getCursorPos(this.$input),i={cursorPos:n,selection:r.getSelection(this.$input),val:{all:e,beforeCursor:e.substr(0,n),afterCursor:e.substr(n)}};t!==void 0?(r.isFunction(t)?t():t).exec(this.$input,i):(this.$input.trigger("ghostwriter:finish"),this.loop?this.restart():this.pause(!0))}return r.mixin(e.prototype,{start:function(t){var e;return this.intervalId||(e=this.story.length?"resume":"start",this.story=this.story.length?this.story:this.manuscript.slice(0),!t&&this.$input.trigger("ghostwriter:"+e).focus(),this.intervalId=setInterval(r.bind(i,this),this.interval)),this},pause:function(t){return this.intervalId&&(!t&&this.$input.trigger("ghostwriter:pause"),clearInterval(this.intervalId),this.intervalId=null),this},stop:function(t){return(this.intervalId||this.story.length)&&!t&&this.$input.trigger("ghostwriter:stop"),this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null),this.story=[],this.reset(),this.$input.blur(),this},restart:function(){return this.stop(),this.start(),this},reset:function(){this.$input.val(this.originalInputVal)}}),e}();r.mixin(t,n.builder(),{haunt:function(t){return new i(t)}})})({},function(){return this}());