{% extends "EncoreCustomerBundle::layout.html.twig" %}

{% block require_js %}
    require(["libs/bootstrap/bootstrap-datepicker"]);
    require(['encore/purchase/seat-selection']);
{% endblock require_js %}

{% block css %}
    <link href="{{ asset('bundles/encorecustomer/css/libs/bootstrap/datepicker.css') }}" rel="stylesheet"/>
{% endblock css %}

{% block content %}
    <article class="seat-selection article">
        <div class="seat-selection-wrap">
            <div id='errorMessageContainer' style='display: none;'>
                <div id='errorMessageDiv' class='alert'>
                    <strong>Warning!</strong>
                    <ul>
                        <li id='errorMessage'/>
                    </ul>
                </div>
            </div>
            <div id="selectDateDiv">
                <label>Date:</label>
                <select id="dateList">
                    <option selected="selected">Select Date</option>
                    {% for dateIndex, date in dateArray %}
                        <option value="{{ date }}">{{ date }}</option>
                    {% endfor %}
                </select>
            </div>

            <div id="selectTimeDiv" hidden="hidden">
                <label>Time:</label>

                <div class="btn-group" data-toggle="buttons-radio">
                    <!--<button type="button" class="btn btn-primary selectTime"></button>-->
                </div>
            </div>

            <div id="selectSectionDiv" hidden="hidden">
                <label>Section:</label>

                <div class="btn-group" data-toggle="buttons-radio">
                    <!--<button type="button" class="btn btn-primary selectSection">{</button>-->
                </div>
            </div>

            <div id="ticketQtyDiv" hidden="hidden">
                <label>Ticket Quantity:</label>
                <input id="ticketQtySelector" type="number" min="0" max="8" value="0"/>
            </div>
            <div id="seatAllocateDiv" hidden="hidden">
                <label>Seat Allocation:</label>

                <div class="table-wrapper">
                    <table class="seatTable">

                    </table>
                </div>
                <input type="button" class="reset" value="reset" id="resetButton"/>
            </div>

            <form id="summaryForm">
                <h2>Summary</h2>
                <table>
                    <tbody>
                    <tr>
                        <td>
                            <div id="eventComplete" class="complete"/>
                        </td>
                        <td>
                            <h3>Event:</h3>

                            <div>
                                <label id="eventLabel">{{ event_name }}</label>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div id="datetimeComplete" class="incomplete"/>
                        </td>
                        <td>
                            <h3>Date & Time:</h3>

                            <div>
                                <label id="dateTimeLabel"/>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div id="sectionComplete" class="incomplete"/>
                        </td>
                        <td>
                            <h3>Section:</h3>

                            <div>
                                <label id="sectionLabel"/>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div id="ticketQtyComplete" class="incomplete"/>
                        </td>
                        <td>
                            <h3>Ticket Quantity:</h3>

                            <div>
                                <label id="ticketQtyLabel"/>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div id="seatAllocComplete" class="incomplete"/>
                        </td>
                        <td>
                            <h3>Seat Allocation:</h3>

                            <div>
                                <label id="seatAllocationLabel"/>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <input class="submit" type="submit" value="next" hidden="hidden"/>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </form>
        </div>
        <input id="eventID" hidden="hidden" data-value="{{ event_id }}"/>
    </article>

    <script type="application/javascript">
        $(function () {
            /**
             * Unselects all selected seats
             * Remove text in seat allocation label at summary form
             * Reset text in ticket quantity label to value to ticket quantity to purchase
             */
            function resetSeats() {
                $("table.seatTable tbody tr td.selected").each(function () {
                    $(this).attr("class", "empty");
                });
                $("#seatAllocationLabel").html("");
            }

            /**
             * Called when reset button for seat allocation is pressed
             * Reset selected seats and change ticket quantity label
             */
            $("#resetButton").click(function () {
                resetSeats();
                $("#ticketQtyLabel").html(parseInt($("#ticketQtySelector").val(), 10) + " unselected ticket(s)");
                $("input:submit").attr("hidden", "hidden");
                $("#seatAllocComplete").attr("class", "incomplete");
            });

            /**
             * Hides/Display time selection step and un-check all checked time radio buttons
             * @param hideFlag
             */
            function hideTimeStep(hideFlag) {
                $("#dateTimeLabel").html("");
                if (hideFlag) {
                    $("#selectTimeDiv").attr("hidden", "hidden");
                } else {
                    $("input:radio[name='timeGroup']").removeAttr("checked");
                    $("#selectTimeDiv").removeAttr("hidden");
                    $("#datetimeComplete").attr("class", "incomplete");
                }
            }

            /**
             * Hides/Display section selection step and un-check all checked section radio buttons
             * @param hideFlag
             */
            function hideSectionStep(hideFlag) {
                $("#sectionLabel").html("");
                if (hideFlag) {
                    $("#selectSectionDiv").attr("hidden", "hidden");
                    $("#datetimeComplete").attr("class", "incomplete");
                } else {
                    $("input:radio[name='sectionGroup']").removeAttr("checked");
                    $("#selectSectionDiv").removeAttr("hidden");
                    $("#datetimeComplete").attr("class", "complete");
                }
            }

            /**
             * Hides/Display ticket quantity step and set ticket quantity to 0
             * @param hideFlag
             */
            function hideTicketQtyStep(hideFlag) {
                $("#ticketQtyLabel").html("");
                if (hideFlag) {
                    $("#ticketQtyDiv").attr("hidden", "hidden");
                    $("#sectionComplete").attr("class", "incomplete");
                } else {
                    $("#ticketQtySelector").val(0);
                    $("#ticketQtyDiv").removeAttr("hidden");
                    $("#sectionComplete").attr("class", "complete");
                }
            }

            /**
             * Hides and reset seat allocation step or Displays seat allocation step
             * @param hideFlag
             */
            function hideSeatAllocateStep(hideFlag) {
                if (hideFlag) {
                    resetSeats();
                    $("#seatAllocateDiv").attr("hidden", "hidden");
                    $("input:submit").attr("hidden", "hidden");
                    $("#seatAllocComplete").attr("class", "incomplete");
                    $("#ticketQtyComplete").attr("class", "incomplete");
                } else {
                    $("#seatAllocateDiv").removeAttr("hidden");
                    $("#ticketQtyComplete").attr("class", "complete");
                }
            }

            /**
             * Hides submit button
             * @param hideFlag
             */
            function hideSubmitButton(hideFlag) {
                if (hideFlag) {
                    $("input:submit").attr("hidden", "hidden");
                    $("#submitComplete").attr("class", "incomplete");
                    $("#seatAllocComplete").attr("class", "incomplete");
                } else {
                    $("input:submit").removeAttr("hidden");
                    $("#seatAllocComplete").attr("class", "complete");
                }
            }

            /**
             * Called when drop down list for date changes
             * If selected date is valid, unhidden time step
             * Else, reset all other values and hide all other steps
             */
            $("#dateList").change(function (e) {
                e.preventDefault();
                var eventID = $("#eventID").data("value");
                var selectedDate = $("#dateList").val();
                console.log(eventID + " " + selectedDate);
                if (selectedDate !== "Select Date") {
                    $.post(
                            "{{ path('encore_select_date') }}",
                            {
                                'id': eventID,
                                'date': selectedDate
                            },
                            function (response) {
                                console.log("%o", response);
                                if (response.code === 200) {
                                    var eventTimes = response.event_times;

                                    $.each(eventTimes, function (index, value){
                                        $("div#selectTimeDiv div").append("<button type='button' class='btn btn-primary selectTime'>" + value + "</button>")
                                    });
                                    return true;
                                } else {
                                    hideTimeStep(true);
                                    hideSectionStep(true);
                                    hideTicketQtyStep(true);
                                    hideSeatAllocateStep(true);
                                    return false;
                                }
                            },
                            "json"
                    );

                    $("#dateTimeLabel").html(selectedDate);
                    hideTimeStep(false);
                } else {
                    hideTimeStep(true);
                }
                hideSectionStep(true);
                hideTicketQtyStep(true);
                hideSeatAllocateStep(true);
            });

            /**
             * Called when radio button for time changes
             * Hides section selection step and hides ticket quantity and seat allocation steps
             */
            $("button.selectTime").click(function (e) {
                hideSectionStep(false);
                $("#dateTimeLabel").html($("#dateList").val() + " " + $(e.target).val());
                hideTicketQtyStep(true);
                hideSeatAllocateStep(true);
            });

            /**
             * Called when radio button for section changes
             * Displays ticket quantity step and hides seat allocation step
             */
            $("button.selectSection").click(function (e) {
                //$("input:radio[name='sectionGroup']").change(function () {
                hideTicketQtyStep(false);
                $("#sectionLabel").html($(e.target).val());
                hideSeatAllocateStep(true);
            });

            /**
             * Called when ticket quantity selector changes
             */
            $("#ticketQtySelector").change(function () {
                var value, selectedLength, difference;
                hideSeatAllocateStep(false);
                value = parseInt($("#ticketQtySelector").val(), 10);
                selectedLength = $("table.seatTable tbody tr td.selected").length;
                if (value < selectedLength) {
                    parseInt($("#ticketQtySelector").val(selectedLength));
                    popupMessageError("You have selected " + selectedLength + " seat(s). You cannot reduce the number of ticket quantity.");
                } else if (value === 0) {
                    $("#ticketQtyLabel").html("");
                    hideSubmitButton(true);
                    hideSeatAllocateStep(true);
                } else {
                    difference = $("#ticketQtySelector").val() - $("table.seatTable tbody tr td.selected").length;
                    $("#ticketQtyLabel").html(difference + " unselected ticket(s)");
                    if (difference > 0) {
                        $("input:submit").attr("hidden", "hidden");
                        $("#seatAllocComplete").attr("class", "incomplete");
                    } else {
                        $("input:submit").removeAttr("hidden");
                        $("#seatAllocComplete").attr("class", "complete");
                    }
                }
            });
        });
    </script>
{% endblock content %}